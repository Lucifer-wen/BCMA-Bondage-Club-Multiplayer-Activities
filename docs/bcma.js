(()=>{"use strict";let e=null,t=null,a=null,n=null,o=null,r=null,i=!1;function l(l,u,d,h){r=h??null,o={roomId:l,host:u,guest:d},function(){if(!i){const e=document.createElement("style");e.textContent="\n.bcma-private-room-overlay {\n\tposition: fixed;\n\tinset: 0;\n\tbackground: rgba(10, 0, 20, 0.85);\n\tdisplay: flex;\n\talign-items: center;\n\tjustify-content: center;\n\tz-index: 6000;\n}\n.bcma-private-room-content {\n\tposition: relative;\n\twidth: 90vw;\n\theight: 90vh;\n\tbackground-size: cover;\n\tbackground-position: center;\n\tbox-shadow: 0 0 25px rgba(0, 0, 0, 0.6);\n\tborder: 2px solid #fff;\n\tdisplay: flex;\n\tflex-direction: column;\n\tpadding: 20px;\n}\n.bcma-private-room-characters {\n\tflex: 1;\n\tdisplay: flex;\n\talign-items: flex-end;\n\tjustify-content: space-around;\n\tgap: 20px;\n}\n.bcma-private-room-character {\n\twidth: 40%;\n\theight: 100%;\n\tdisplay: flex;\n\talign-items: flex-end;\n\tjustify-content: center;\n}\n.bcma-private-room-character img {\n\tmax-width: 100%;\n\tmax-height: 100%;\n\tobject-fit: contain;\n}\n.bcma-private-room-actions {\n\tdisplay: flex;\n\tjustify-content: flex-end;\n\tgap: 10px;\n}\n.bcma-private-room-actions button {\n\tpadding: 10px 16px;\n\tfont-size: 16px;\n\tborder: 1px solid #fff;\n\tbackground: rgba(0, 0, 0, 0.6);\n\tcolor: #fff;\n\tcursor: pointer;\n}\n.bcma-private-room-actions button:hover {\n\tbackground: rgba(255, 255, 255, 0.15);\n}\n",document.head.appendChild(e),i=!0}if(e)return;e=document.createElement("div"),e.className="bcma-private-room-overlay",t=document.createElement("div"),t.className="bcma-private-room-content",t.style.backgroundImage='url("Backgrounds/PrivateRoom.jpg")';const o=document.createElement("div");o.className="bcma-private-room-characters",a=document.createElement("div"),a.className="bcma-private-room-character",n=document.createElement("div"),n.className="bcma-private-room-character",o.appendChild(a),o.appendChild(n);const r=document.createElement("div");r.className="bcma-private-room-actions";const l=document.createElement("button");l.type="button",l.textContent="Leave private room",l.onclick=()=>c(),r.appendChild(l),t.appendChild(o),t.appendChild(r),e.appendChild(t),document.body.appendChild(e)}(),function(){if(!o||!a||!n)return;const e=m(o.host),t=m(o.guest);s(e,a),s(t,n)}()}function c(i=!0){if(i&&r)try{r()}catch(e){console.error("[BCMA] Private room close callback failed",e)}r=null,o=null,e&&(e.remove(),e=null,t=null,a=null,n=null)}function s(e,t){if(t.innerHTML="",!e){const e=document.createElement("p");return e.style.color="#fff",e.textContent="Unavailable",void t.appendChild(e)}try{CharacterLoadCanvas?CharacterLoadCanvas(e):CharacterRefresh?.(e);const a=e.Canvas||e.CanvasBlink;if(a){const n=document.createElement("img");return n.alt=e.Nickname??e.Name??"Player",n.src=a.toDataURL("image/png"),void t.appendChild(n)}}catch(e){console.error("[BCMA] Failed to render character canvas",e)}const a=document.createElement("p");a.style.color="#fff",a.textContent=e.Nickname??e.Name??`Player ${e.MemberNumber??"?"}`,t.appendChild(a)}function m(e){if("number"!=typeof e)return null;if(Player?.MemberNumber===e)return Player??null;if(Array.isArray(ChatRoomCharacter)){const t=ChatRoomCharacter.find(t=>t.MemberNumber===e);if(t)return t}return null}const u=Object.freeze([{id:"ClubCard",difficulty:0,labelSelf:"(Practice the Club Card mini-game.)",descriptionSelf:"(Launches a solo Club Card practice round.)",labelTarget:"(Invite DialogCharacterObject to play Club Card.)",descriptionTarget:"(Launches a Club Card practice round for you and DialogCharacterObject.)"},{id:"Chess",difficulty:0,labelSelf:"(Play a practice chess match.)",descriptionSelf:"(Loads the chess mini-game locally.)",labelTarget:"(Challenge DialogCharacterObject to chess.)",descriptionTarget:"(Loads the chess mini-game for you and DialogCharacterObject.)"},{id:"DojoStruggle",difficulty:0,labelSelf:"(Run a dojo struggle drill.)",descriptionSelf:"(Starts the dojo struggle mini-game.)",labelTarget:"(Invite DialogCharacterObject to a dojo struggle drill.)",descriptionTarget:"(Starts the dojo struggle mini-game for DialogCharacterObject.)"},{id:"GetUp",difficulty:0,labelSelf:"(Attempt the Get Up challenge.)",descriptionSelf:"(Starts the Get Up mini-game with a basic difficulty.)",labelTarget:"(Make DialogCharacterObject attempt the Get Up challenge.)",descriptionTarget:"(Starts the Get Up mini-game so DialogCharacterObject can practice.)"},{id:"MaidCleaning",difficulty:"Normal",labelSelf:"(Start maid cleaning practice.)",descriptionSelf:"(Runs the maid cleaning mini-game at a normal pace.)",labelTarget:"(Invite DialogCharacterObject to maid cleaning practice.)",descriptionTarget:"(Runs the maid cleaning mini-game for DialogCharacterObject.)"},{id:"MaidDrinks",difficulty:"Normal",labelSelf:"(Start maid drink service practice.)",descriptionSelf:"(Runs the maid drink service mini-game at a normal pace.)",labelTarget:"(Invite DialogCharacterObject to maid drink service practice.)",descriptionTarget:"(Runs the maid drink service mini-game for DialogCharacterObject.)"},{id:"HorseWalk",difficulty:"Hurdle",labelSelf:"(Race through a horse walk hurdle course.)",descriptionSelf:"(Runs the horse walk mini-game on the hurdle preset.)",labelTarget:"(Invite DialogCharacterObject to a horse walk hurdle course.)",descriptionTarget:"(Runs the horse walk mini-game so DialogCharacterObject can compete.)"},{id:"MagicPuzzle",difficulty:20,labelSelf:"(Practice spell casting puzzles.)",descriptionSelf:"(Loads a Magic Puzzle session.)",labelTarget:"(Invite DialogCharacterObject to practice spell casting puzzles.)",descriptionTarget:"(Loads a Magic Puzzle session for you and DialogCharacterObject.)"},{id:"Therapy",difficulty:1,labelSelf:"(Start a therapy mini-game.)",descriptionSelf:"(Runs the therapy mini-game locally.)",labelTarget:"(Invite DialogCharacterObject to the therapy mini-game.)",descriptionTarget:"(Runs the therapy mini-game for DialogCharacterObject.)"},{id:"Tennis",difficulty:1,labelSelf:"(Practice a tennis mini-game.)",descriptionSelf:"(Loads the tennis mini-game locally.)",labelTarget:"(Invite DialogCharacterObject to tennis drills.)",descriptionTarget:"(Loads the tennis mini-game for you and DialogCharacterObject.)"}]),d=new Map(u.map(e=>[e.id,e])),h=Object.freeze([{id:"Cafe",name:"the Cafe",module:"Room",screen:"Cafe",labelSelf:"(Visit the cafe.)",descriptionSelf:"(Leave the chatroom and grab a snack at the cafe.)",labelTarget:"(Invite DialogCharacterObject to the cafe.)",descriptionTarget:"(Requests DialogCharacterObject to accompany you to the cafe.)"},{id:"Arcade",name:"the Arcade",module:"Room",screen:"Arcade",labelSelf:"(Visit the arcade.)",descriptionSelf:"(Walk over to the club's arcade corner.)",labelTarget:"(Invite DialogCharacterObject to the arcade.)",descriptionTarget:"(Requests DialogCharacterObject to follow you to the arcade.)"},{id:"Stable",name:"the Stable",module:"Room",screen:"Stable",labelSelf:"(Walk to the stables.)",descriptionSelf:"(Head over to the horse stables.)",labelTarget:"(Invite DialogCharacterObject to the stables.)",descriptionTarget:"(Requests DialogCharacterObject to join you at the stables.)"},{id:"Magic",name:"the Magic Theater",module:"Room",screen:"Magic",labelSelf:"(Visit the magic theater.)",descriptionSelf:"(Go see what's happening at the magic theater.)",labelTarget:"(Invite DialogCharacterObject to the magic theater.)",descriptionTarget:"(Requests DialogCharacterObject to come with you to the theater.)"},{id:"Nursery",name:"the Nursery",module:"Room",screen:"Nursery",labelSelf:"(Visit the nursery.)",descriptionSelf:"(Step into the nursery area.)",labelTarget:"(Invite DialogCharacterObject to the nursery.)",descriptionTarget:"(Requests DialogCharacterObject to enter the nursery with you.)"},{id:"Gambling",name:"the Gambling Hall",module:"Room",screen:"Gambling",labelSelf:"(Try your luck in the gambling hall.)",descriptionSelf:"(Walk to the main hall's gambling den.)",labelTarget:"(Invite DialogCharacterObject to the gambling hall.)",descriptionTarget:"(Requests DialogCharacterObject to gamble with you.)"},{id:"Prison",name:"the Prison",module:"Room",screen:"Prison",labelSelf:"(Visit the prison wing.)",descriptionSelf:"(Go check on the prison cells.)",labelTarget:"(Invite DialogCharacterObject to the prison wing.)",descriptionTarget:"(Requests DialogCharacterObject to walk to the prison wing with you.)"},{id:"Photographic",name:"the Photographic Studio",module:"Room",screen:"Photographic",labelSelf:"(Visit the photographic studio.)",descriptionSelf:"(Walk over to the photography studio.)",labelTarget:"(Invite DialogCharacterObject to the photographic studio.)",descriptionTarget:"(Requests DialogCharacterObject to have a photoshoot with you.)"},{id:"Private",name:"your Private Room",module:"Room",screen:"Private",mode:"privateSimulation",labelSelf:"(Go to your private room.)",descriptionSelf:"(Head over to your own private space.)",labelTarget:"(Invite DialogCharacterObject to your private room.)",descriptionTarget:"(Requests DialogCharacterObject to join you in your private room.)"},{id:"KidnapLeague",name:"the Kidnap League",module:"Room",screen:"KidnapLeague",labelSelf:"(Visit the Kidnap League.)",descriptionSelf:"(Walk to the Kidnap League headquarters.)",labelTarget:"(Invite DialogCharacterObject to the Kidnap League.)",descriptionTarget:"(Requests DialogCharacterObject to head to the Kidnap League.)"},{id:"Shibari",name:"the Shibari Dojo",module:"Room",screen:"Shibari",labelSelf:"(Visit the Shibari dojo.)",descriptionSelf:"(Practice knots at the dojo.)",labelTarget:"(Invite DialogCharacterObject to the Shibari dojo.)",descriptionTarget:"(Requests DialogCharacterObject to train with you at the dojo.)"},{id:"SlaveMarket",name:"the Slave Market",module:"Room",screen:"SlaveMarket",labelSelf:"(Visit the slave market.)",descriptionSelf:"(Leave to browse the slave market.)",labelTarget:"(Invite DialogCharacterObject to the slave market.)",descriptionTarget:"(Requests DialogCharacterObject to join you at the market.)"},{id:"Cell",name:"the Holding Cells",module:"Room",screen:"Cell",labelSelf:"(Visit the holding cells.)",descriptionSelf:"(Walk to the detention cells.)",labelTarget:"(Invite DialogCharacterObject to the holding cells.)",descriptionTarget:"(Requests DialogCharacterObject to step into the cells with you.)"},{id:"Shop",name:"the Club Shop",module:"Room",screen:"Shop",labelSelf:"(Visit the club shop.)",descriptionSelf:"(Walk over to the club shop.)",labelTarget:"(Invite DialogCharacterObject to the club shop.)",descriptionTarget:"(Requests DialogCharacterObject to browse the club shop with you.)"},{id:"MagicSchoolLaboratory",name:"the Magic School Laboratory",module:"Room",screen:"MagicSchoolLaboratory",labelSelf:"(Visit the magic school laboratory.)",descriptionSelf:"(Walk to the magic school's lab.)",labelTarget:"(Invite DialogCharacterObject to the magic school laboratory.)",descriptionTarget:"(Requests DialogCharacterObject to join you in the lab.)",requiresCanChange:!0},{id:"Poker",name:"the Poker room",module:"Room",screen:"Poker",labelSelf:"(Head to the poker room.)",descriptionSelf:"(Leave the chat and sit down for poker.)",labelTarget:"(Invite DialogCharacterObject to the poker room.)",descriptionTarget:"(Requests DialogCharacterObject to play poker with you.)",requiresCanChange:!0,requiresCanTalk:!0,requiresNotRestrained:!0},{id:"Infiltration",name:"the Infiltration training",module:"Room",screen:"Infiltration",labelSelf:"(Visit infiltration training.)",descriptionSelf:"(Walk to the infiltration course.)",labelTarget:"(Invite DialogCharacterObject to infiltration training.)",descriptionTarget:"(Requests DialogCharacterObject to join you in infiltration training.)",requiresCanChange:!0},{id:"MovieStudio",name:"the Movie Studio",module:"Room",screen:"MovieStudio",labelSelf:"(Visit the movie studio.)",descriptionSelf:"(Walk to the film studio.)",labelTarget:"(Invite DialogCharacterObject to the movie studio.)",descriptionTarget:"(Requests DialogCharacterObject to join you on set.)",requiresCanChange:!0}]),g=new Map(h.map(e=>[e.id,e])),f="100",p="9100",b="40",C="9200",y="9300",S="9400",M=Symbol("bcma-self-dialog"),v=Symbol("bcma-target-dialog"),T=new Map,I=new Set,D=new Map,R=new Set;let P,w,k=null,A=!1,O=!1,j=null,B=!1,N=!1;const x={Tennis:{prepareState:e=>{globalThis.TennisCharacterLeft=Player??null,globalThis.TennisCharacterRight=e??null,Player&&!Player.Name&&(Player.Name=CharacterNickname(Player)),e&&!e.Name&&(e.Name=CharacterNickname(e))},initSync:(e,t)=>function(e,t){if("number"!=typeof Player?.MemberNumber||"number"!=typeof e.MemberNumber)return void(k=null);const a=globalThis;k={matchId:t,opponentMember:e.MemberNumber,leftMember:Player.MemberNumber,rightMember:e.MemberNumber,lastLeft:"number"==typeof a.TennisCharacterLeftPoint?a.TennisCharacterLeftPoint:0,lastRight:"number"==typeof a.TennisCharacterRightPoint?a.TennisCharacterRightPoint:0}}(e,t)}};function L(e=10){!function(){let e=!1;if(Player&&(e=q(Player)||e),Array.isArray(ChatRoomCharacter))for(const t of ChatRoomCharacter)e=q(t)||e;return e}()&&e>0&&setTimeout(()=>L(e-1),500)}function q(e){return!(!e||!Array.isArray(e.Dialog))&&(e.IsPlayer?.()?function(e){if(e[M])return!1;const t=e.Dialog;if(!Array.isArray(t))return!1;let a=!1;a=$(t,V({Stage:f,NextStage:p,Option:"(BCMA: Launch an activity.)",Result:"(Pick one of the club's built-in mini-games to play or practice.)",Prerequisite:"DialogBCMACanShowMiniGamesSelf()"}))||a,a=$(t,V({Stage:f,NextStage:y,Option:"(BCMA: Visit a club area.)",Result:"(Travel to one of the private club rooms.)",Prerequisite:"DialogBCMACanShowRoomsSelf()"}))||a;for(const e of G(!0))a=$(t,e)||a;for(const e of E(!0))a=$(t,e)||a;return a&&(e[M]=!0),a}(e):!!e.IsOnline?.()&&function(e){if(e[v])return!1;const t=e.Dialog;if(!Array.isArray(t))return!1;let a=!1;a=$(t,V({Stage:b,NextStage:C,Option:"(BCMA: Invite DialogCharacterObject to an activity.)",Result:"(Pick one of the club's built-in mini-games to launch locally.)",Prerequisite:"DialogBCMACanShowMiniGamesTarget()"}))||a,a=$(t,V({Stage:b,NextStage:S,Option:"(BCMA: Visit a club area together.)",Result:"(Invite DialogCharacterObject to follow you into one of the club rooms.)",Prerequisite:"DialogBCMACanShowRoomsTarget()"}))||a;for(const e of G(!1))a=$(t,e)||a;for(const e of E(!1))a=$(t,e)||a;return a&&(e[v]=!0),a}(e))}function G(e){const t=e?p:C,a=e?f:b,n=[];for(const a of u)n.push(V({Stage:t,Option:e?a.labelSelf:a.labelTarget,Result:e?a.descriptionSelf:a.descriptionTarget,Function:e?`DialogBCMAStartMiniGame("${a.id}")`:`DialogBCMAStartMiniGameTarget("${a.id}")`}));return n.push(V({Stage:t,NextStage:a,Option:"(Back to character actions.)",Result:"(Possible character actions.)"})),n}function E(e){const t=e?y:S,a=e?f:b,n=[];for(const a of h)n.push(V({Stage:t,Option:e?a.labelSelf:a.labelTarget,Result:e?a.descriptionSelf:a.descriptionTarget,Function:e?`DialogBCMAVisitRoom("${a.id}")`:`DialogBCMAInviteRoom("${a.id}")`}));return n.push(V({Stage:t,NextStage:a,Option:"(Back to character actions.)",Result:"(Return to the main list of character interactions.)"})),n}function $(e,t){return!(!t.Option||!t.Stage)&&(!e.some(e=>e.Stage===t.Stage&&e.Option===t.Option)&&(e.push(t),!0))}function V({Stage:e,NextStage:t=null,Option:a=null,Result:n=null,Function:o=null,Prerequisite:r=null,Group:i=null,Trait:l=null}){return{Stage:e??null,NextStage:t,Option:a,Result:n,Function:o,Prerequisite:r,Group:i,Trait:l}}function z(e){if("function"==typeof MiniGameStart){"Tennis"!==e.id&&(k=null);try{MiniGameStart(e.id,e.difficulty??0,"DialogBCMAMiniGameReturn")}catch(t){console.error("[BCMA] Failed to start mini-game",e.id,t)}}}function W(e){return e?e.Nickname?e.Nickname:e.Name?e.Name:"number"==typeof e.MemberNumber?`Player ${e.MemberNumber}`:"Unknown player":"Unknown player"}function U(e,t){ServerPlayerIsInChatRoom()&&ServerSend("ChatRoomChat",{Content:"BCMA",Type:"Hidden",Target:e,Dictionary:t})}function H(){if(B)return;const e=globalThis.ChatRoomMessage;"function"==typeof e?(globalThis.ChatRoomMessage=function(t,...a){if("Hidden"!==t?.Type||"BCMA"!==t.Content||"object"!=typeof t.Dictionary)return e.call(this,t,...a);!function(e,t){if("string"==typeof t?.action)switch(t.action){case"invite":!function(e,t){if(t.target!==Player?.MemberNumber)return;const a=Y(e),n=d.get(t.gameId);if(!n||!a)return void U(e,{action:"response",id:t.id,gameId:t.gameId,accepted:!1});const o=x[t.gameId];K(`${t.initiatorName} wants to play ${t.gameId}. Accept?`,()=>{o&&(o.prepareState(a),o.initSync?.(a,t.matchId??Q())),z(n),U(e,{action:"response",id:t.id,gameId:t.gameId,accepted:!0,matchId:t.matchId}),_()},()=>{U(e,{action:"response",id:t.id,gameId:t.gameId,accepted:!1,matchId:t.matchId}),_()})}(e,t);break;case"response":!function(e){if(!I.has(e.id))return;I.delete(e.id);const t=T.get(e.id);if(T.delete(e.id),!t)return;if(!e.accepted)return void window.alert("BCMA: Invitation declined.");const a=d.get(t.gameId);if(!a)return;const n=x[t.gameId];n&&(n.prepareState(t.opponent),n.initSync?.(t.opponent,t.matchId??e.matchId??Q())),z(a)}(t);break;case"forceStart":!function(e,t){const a=x[t.gameId],n=d.get(t.gameId);if(!a||!n)return;const o=Y(e);o&&(a.prepareState(o),a.initSync?.(o,t.matchId??Q()),z(n))}(e,t);break;case"tennisScore":!function(e){if(k&&e.matchId===k.matchId){A=!0;try{const t=globalThis,a=Player?.MemberNumber;a&&e.leftMember===a?(t.TennisCharacterLeftPoint=e.leftPoints,t.TennisCharacterRightPoint=e.rightPoints):a&&e.rightMember===a?(t.TennisCharacterLeftPoint=e.rightPoints,t.TennisCharacterRightPoint=e.leftPoints):(t.TennisCharacterLeftPoint=e.leftPoints,t.TennisCharacterRightPoint=e.rightPoints),k.lastLeft="number"==typeof t.TennisCharacterLeftPoint?t.TennisCharacterLeftPoint:0,k.lastRight="number"==typeof t.TennisCharacterRightPoint?t.TennisCharacterRightPoint:0}finally{A=!1}}}(t);break;case"roomInvite":!function(e,t){if(t.target!==Player?.MemberNumber)return;const a=Y(e),n=g.get(t.roomId);n&&a&&ee(n,Player)?K(`${t.initiatorName} wants to bring you to ${n.name}. Accept?`,()=>{te(n,{hostMember:t.initiator,guestMember:t.target}),U(e,{action:"roomResponse",id:t.id,roomId:t.roomId,accepted:!0}),_()},()=>{U(e,{action:"roomResponse",id:t.id,roomId:t.roomId,accepted:!1}),_()}):U(e,{action:"roomResponse",id:t.id,roomId:t.roomId,accepted:!1})}(e,t);break;case"roomResponse":!function(e){if(!R.has(e.id))return;R.delete(e.id);const t=D.get(e.id);if(D.delete(e.id),!t)return;if(!e.accepted)return void window.alert("BCMA: Invitation declined.");const a=g.get(t.roomId);if(!a||!ee(a,Player))return;const n=t.opponent.MemberNumber??Player?.MemberNumber;te(a,{hostMember:Player?.MemberNumber,guestMember:n})}(t);break;case"roomForce":!function(e,t){const a=g.get(t.roomId);a&&ee(a,Player)&&Y(e)&&te(a,{hostMember:e,guestMember:Player?.MemberNumber})}(e,t);break;case"roomSimClose":!function(e){j&&j.roomId===e.roomId&&(ne(!1),window.alert("BCMA: The other player left the private room."))}(t)}}(t.Sender,t.Dictionary)},B=!0):setTimeout(H,500)}let F=null;function K(e,t,a){_(),function(){if(N)return;const e=document.createElement("style");e.textContent="\n.bcma-opponent-overlay {\n\tposition: fixed;\n\tinset: 0;\n\tbackground: rgba(0, 0, 0, 0.6);\n\tdisplay: flex;\n\talign-items: center;\n\tjustify-content: center;\n\tz-index: 5000;\n}\n.bcma-opponent-dialog {\n\tbackground: #1b1b1f;\n\tcolor: white;\n\tborder: 1px solid #fff;\n\tpadding: 20px;\n\tmax-width: 420px;\n\twidth: 90%;\n\ttext-align: center;\n\tfont-family: Arial, sans-serif;\n\tbox-shadow: 0 0 15px rgba(0, 0, 0, 0.5);\n}\n.bcma-opponent-list {\n\tdisplay: flex;\n\tflex-direction: column;\n\tgap: 10px;\n\tmargin-top: 15px;\n}\n.bcma-opponent-list button {\n\tpadding: 10px;\n\tborder: 1px solid #5a5a74;\n\tbackground: #2d2d3a;\n\tcolor: white;\n\tcursor: pointer;\n}\n.bcma-opponent-list button:hover {\n\tbackground: #38384d;\n}\n",document.head.appendChild(e),N=!0}(),F=document.createElement("div"),F.className="bcma-opponent-overlay";const n=document.createElement("div");n.className="bcma-opponent-dialog";const o=document.createElement("p");o.textContent=e,n.appendChild(o);const r=document.createElement("div");r.className="bcma-opponent-list";const i=document.createElement("button");i.type="button",i.textContent="Accept",i.onclick=t;const l=document.createElement("button");l.type="button",l.textContent="Decline",l.onclick=a,r.appendChild(i),r.appendChild(l),n.appendChild(r),F.appendChild(n),document.body.appendChild(F)}function _(){F&&(F.remove(),F=null)}function Y(e){return(Array.isArray(ChatRoomCharacter)?ChatRoomCharacter.find(t=>t.MemberNumber===e):null)??null}function J(){return`${Player?.MemberNumber??"0"}-${Date.now()}-${Math.random().toString(36).slice(2)}`}function Q(){return`${Player?.MemberNumber??"0"}-match-${Date.now()}-${Math.random().toString(36).slice(2)}`}function X(){try{return"function"==typeof ServerPlayerIsInChatRoom&&ServerPlayerIsInChatRoom()}catch{return!1}}function Z(){if(O)return;const e=globalThis,t=e.TennisRun;"function"==typeof t?(e.TennisRun=function(...e){const a=t.apply(this,e);return function(){if(!k||A)return;const e=globalThis,t="number"==typeof e.TennisCharacterLeftPoint?e.TennisCharacterLeftPoint:0,a="number"==typeof e.TennisCharacterRightPoint?e.TennisCharacterRightPoint:0;t===k.lastLeft&&a===k.lastRight||(k.lastLeft=t,k.lastRight=a,U(k.opponentMember,{action:"tennisScore",gameId:"Tennis",matchId:k.matchId,leftMember:k.leftMember,rightMember:k.rightMember,leftPoints:t,rightPoints:a}))}(),a},O=!0):setTimeout(Z,500)}function ee(e,t){const a=t??null;return!!a&&!(!1!==e.requiresCanWalk&&"function"==typeof a.CanWalk&&!a.CanWalk()||e.requiresCanChange&&"function"==typeof a.CanChangeOwnClothes&&!a.CanChangeOwnClothes()||e.requiresCanTalk&&"function"==typeof a.CanTalk&&!a.CanTalk()||e.requiresNotRestrained&&"function"==typeof a.IsRestrained&&a.IsRestrained())}function te(e,t){if("privateSimulation"!==e.mode)if(ne(!0),"function"==typeof CommonSetScreen)try{CommonSetScreen(e.module,e.screen)}catch(t){console.error("[BCMA] Failed to move to room",e.id,t)}else console.warn("[BCMA] Cannot move to room, CommonSetScreen unavailable");else!function(e,t){ne(!0);const a=t?.hostMember??Player?.MemberNumber,n=t?.guestMember??Player?.MemberNumber;if("number"!=typeof a||"number"!=typeof n)return void console.warn("[BCMA] Missing host/guest information for simulated room",e.id);const o=Player?.MemberNumber,r=o===a?n:a;j={roomId:e.id,host:a,guest:n,opponent:r===o?void 0:r},l(e.id,a,n,()=>{ae(!0)})}(e,t)}function ae(e){if(!j)return;const{opponent:t,roomId:a}=j;j=null,e&&t&&U(t,{action:"roomSimClose",roomId:a})}function ne(e){j&&ae(e),c(!1)}function oe(){const e=Player;return!(!e||"function"==typeof e.CanWalk&&!e.CanWalk())}globalThis.BCMA_LOADED||(globalThis.BCMA_LOADED=!0,console.log(`[BCMA] Loading Bondage Club Multiplayer Activities v${globalThis.BCMA_VERSION??"dev"}`),function(){const e=globalThis;e.DialogBCMAStartMiniGame||(e.DialogBCMAStartMiniGame=e=>function(e){const t=d.get(e);return t?x[e]?(window.alert("BCMA: Please click on the opponent's character actions to start this activity."),!1):(z(t),!0):(console.warn(`[BCMA] Unknown mini-game requested: ${e}`),!1)}(e)),e.DialogBCMAStartMiniGameTarget||(e.DialogBCMAStartMiniGameTarget=e=>function(e){const t=d.get(e);if(!t)return console.warn(`[BCMA] Unknown mini-game requested: ${e}`),!1;const a=CurrentCharacter;if(!a||"function"!=typeof a.IsOnline||!a.IsOnline())return console.warn("[BCMA] No valid opponent selected"),!1;const n=x[e];if(n&&"number"==typeof a.MemberNumber){const o=a.MemberNumber;if(a.IsOwnedByPlayer?.()){n.prepareState(a);const r=Q();return n.initSync?.(a,r),U(o,{action:"forceStart",gameId:e,initiator:Player?.MemberNumber??-1,matchId:r}),z(t),!0}const r=Q(),i=J();return T.set(i,{gameId:e,opponent:a,matchId:r}),I.add(i),U(o,{action:"invite",id:i,gameId:e,initiator:Player?.MemberNumber??-1,target:o,initiatorName:W(Player),matchId:r}),window.alert(`BCMA: Invitation sent to ${W(a)}.`),!0}return n?(console.warn("[BCMA] Cannot start this game without a valid opponent."),!1):(z(t),!0)}(e)),e.DialogBCMACanShowMiniGamesSelf||(e.DialogBCMACanShowMiniGamesSelf=()=>X()),e.DialogBCMACanShowMiniGamesTarget||(e.DialogBCMACanShowMiniGamesTarget=()=>{const t=e.CurrentCharacter;return!(!t||t===e.Player)&&("function"!=typeof t.IsPlayer||!t.IsPlayer())&&("function"!=typeof InventoryIsBlockedByDistance||!InventoryIsBlockedByDistance(t))&&X()}),e.DialogBCMACanShowMiniGames||(e.DialogBCMACanShowMiniGames=()=>{const t=e.CurrentCharacter;return t&&"function"==typeof t.IsPlayer&&t.IsPlayer()?e.DialogBCMACanShowMiniGamesSelf():e.DialogBCMACanShowMiniGamesTarget()}),e.DialogBCMAMiniGameReturn||(e.DialogBCMAMiniGameReturn=()=>{"string"==typeof CurrentModule&&"string"==typeof CurrentScreen&&"ChatRoom"===CurrentScreen||"function"==typeof CommonSetScreen&&CommonSetScreen("Online","ChatRoom")}),e.DialogBCMAVisitRoom||(e.DialogBCMAVisitRoom=e=>function(e){const t=g.get(e);return t?X()&&oe()&&ee(t,Player)?(te(t,{hostMember:Player?.MemberNumber,guestMember:Player?.MemberNumber}),!0):(window.alert("BCMA: You cannot travel there right now."),!1):(console.warn("[BCMA] Unknown room requested",e),!1)}(e)),e.DialogBCMAInviteRoom||(e.DialogBCMAInviteRoom=e=>function(e){const t=g.get(e);if(!t)return console.warn("[BCMA] Unknown room requested",e),!1;if(!X()||!oe()||!ee(t,Player))return window.alert("BCMA: You cannot travel there right now."),!1;const a=CurrentCharacter;if(!a||"function"!=typeof a.IsOnline||!a.IsOnline())return console.warn("[BCMA] No valid opponent selected for room invite"),!1;if("number"!=typeof a.MemberNumber)return console.warn("[BCMA] Target is missing a member number"),!1;if(a.IsOwnedByPlayer?.())return U(a.MemberNumber,{action:"roomForce",roomId:e,initiator:Player?.MemberNumber??-1}),te(t,{hostMember:Player?.MemberNumber,guestMember:a.MemberNumber}),!0;const n=J();return D.set(n,{roomId:e,opponent:a}),R.add(n),U(a.MemberNumber,{action:"roomInvite",id:n,roomId:e,initiator:Player?.MemberNumber??-1,target:a.MemberNumber,initiatorName:W(Player)}),window.alert(`BCMA: Invitation sent to ${W(a)}.`),!0}(e)),e.DialogBCMACanShowRoomsSelf||(e.DialogBCMACanShowRoomsSelf=()=>oe()&&X()),e.DialogBCMACanShowRoomsTarget||(e.DialogBCMACanShowRoomsTarget=()=>{const t=e.CurrentCharacter;return!(!t||t===e.Player)&&("function"!=typeof t.IsPlayer||!t.IsPlayer())&&("function"!=typeof InventoryIsBlockedByDistance||!InventoryIsBlockedByDistance(t))&&oe()&&X()})}(),function(){const e=globalThis;if(P)return;const t=e.CharacterBuildDialog;"function"==typeof t?(P=t,e.CharacterBuildDialog=function(e,t,a,n){P?.call(this,e,t,a,n),q(e)}):console.warn("[BCMA] CharacterBuildDialog is not available; mini-game menu injection skipped.")}(),function(){const e=globalThis;if(w)return;const t=e.DialogCanPerformCharacterAction;"function"==typeof t&&(w=t,e.DialogCanPerformCharacterAction=function(){return!!w?.call(this)||"function"==typeof e.DialogBCMACanShowMiniGames&&e.DialogBCMACanShowMiniGames()})}(),L(),H(),Z())})();