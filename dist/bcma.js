(()=>{"use strict";const e=Object.freeze([{id:"ClubCard",difficulty:0,labelSelf:"(Practice the Club Card mini-game.)",descriptionSelf:"(Launches a solo Club Card practice round.)",labelTarget:"(Invite DialogCharacterObject to play Club Card.)",descriptionTarget:"(Launches a Club Card practice round for you and DialogCharacterObject.)"},{id:"Chess",difficulty:0,labelSelf:"(Play a practice chess match.)",descriptionSelf:"(Loads the chess mini-game locally.)",labelTarget:"(Challenge DialogCharacterObject to chess.)",descriptionTarget:"(Loads the chess mini-game for you and DialogCharacterObject.)"},{id:"DojoStruggle",difficulty:0,labelSelf:"(Run a dojo struggle drill.)",descriptionSelf:"(Starts the dojo struggle mini-game.)",labelTarget:"(Invite DialogCharacterObject to a dojo struggle drill.)",descriptionTarget:"(Starts the dojo struggle mini-game for DialogCharacterObject.)"},{id:"GetUp",difficulty:0,labelSelf:"(Attempt the Get Up challenge.)",descriptionSelf:"(Starts the Get Up mini-game with a basic difficulty.)",labelTarget:"(Make DialogCharacterObject attempt the Get Up challenge.)",descriptionTarget:"(Starts the Get Up mini-game so DialogCharacterObject can practice.)"},{id:"MaidCleaning",difficulty:"Normal",labelSelf:"(Start maid cleaning practice.)",descriptionSelf:"(Runs the maid cleaning mini-game at a normal pace.)",labelTarget:"(Invite DialogCharacterObject to maid cleaning practice.)",descriptionTarget:"(Runs the maid cleaning mini-game for DialogCharacterObject.)"},{id:"MaidDrinks",difficulty:"Normal",labelSelf:"(Start maid drink service practice.)",descriptionSelf:"(Runs the maid drink service mini-game at a normal pace.)",labelTarget:"(Invite DialogCharacterObject to maid drink service practice.)",descriptionTarget:"(Runs the maid drink service mini-game for DialogCharacterObject.)"},{id:"HorseWalk",difficulty:"Hurdle",labelSelf:"(Race through a horse walk hurdle course.)",descriptionSelf:"(Runs the horse walk mini-game on the hurdle preset.)",labelTarget:"(Invite DialogCharacterObject to a horse walk hurdle course.)",descriptionTarget:"(Runs the horse walk mini-game so DialogCharacterObject can compete.)"},{id:"MagicPuzzle",difficulty:20,labelSelf:"(Practice spell casting puzzles.)",descriptionSelf:"(Loads a Magic Puzzle session.)",labelTarget:"(Invite DialogCharacterObject to practice spell casting puzzles.)",descriptionTarget:"(Loads a Magic Puzzle session for you and DialogCharacterObject.)"},{id:"Therapy",difficulty:1,labelSelf:"(Start a therapy mini-game.)",descriptionSelf:"(Runs the therapy mini-game locally.)",labelTarget:"(Invite DialogCharacterObject to the therapy mini-game.)",descriptionTarget:"(Runs the therapy mini-game for DialogCharacterObject.)"},{id:"Tennis",difficulty:1,labelSelf:"(Practice a tennis mini-game.)",descriptionSelf:"(Loads the tennis mini-game locally.)",labelTarget:"(Invite DialogCharacterObject to tennis drills.)",descriptionTarget:"(Loads the tennis mini-game for you and DialogCharacterObject.)"}]),t=new Map(e.map(e=>[e.id,e])),a="9100",n="9200",i=Symbol("bcma-self-dialog"),r=Symbol("bcma-target-dialog"),o=new Map,l=new Set;let c,s,u=!1,d=!1;const g={Tennis:{prepareState:e=>{globalThis.TennisCharacterLeft=Player??null,globalThis.TennisCharacterRight=e??null,Player&&!Player.Name&&(Player.Name=CharacterNickname(Player)),e&&!e.Name&&(e.Name=CharacterNickname(e))}}};function m(e=10){!function(){let e=!1;if(Player&&(e=p(Player)||e),Array.isArray(ChatRoomCharacter))for(const t of ChatRoomCharacter)e=p(t)||e;return e}()&&e>0&&setTimeout(()=>m(e-1),500)}function p(e){return!(!e||!Array.isArray(e.Dialog))&&(e.IsPlayer?.()?function(e){if(e[i])return!1;const t=e.Dialog;if(!Array.isArray(t))return!1;let n=!1;n=h(t,C({Stage:"100",NextStage:a,Option:"(BCMA: Launch an activity.)",Result:"(Pick one of the club's built-in mini-games to play or practice.)",Prerequisite:"DialogBCMACanShowMiniGamesSelf()"}))||n;for(const e of f(!0))n=h(t,e)||n;return n&&(e[i]=!0),n}(e):!!e.IsOnline?.()&&function(e){if(e[r])return!1;const t=e.Dialog;if(!Array.isArray(t))return!1;let a=!1;a=h(t,C({Stage:"40",NextStage:n,Option:"(BCMA: Invite DialogCharacterObject to an activity.)",Result:"(Pick one of the club's built-in mini-games to launch locally.)",Prerequisite:"DialogBCMACanShowMiniGamesTarget()"}))||a;for(const e of f(!1))a=h(t,e)||a;return a&&(e[r]=!0),a}(e))}function f(t){const i=t?a:n,r=t?"100":"40",o=[];for(const a of e)o.push(C({Stage:i,Option:t?a.labelSelf:a.labelTarget,Result:t?a.descriptionSelf:a.descriptionTarget,Function:t?`DialogBCMAStartMiniGame("${a.id}")`:`DialogBCMAStartMiniGameTarget("${a.id}")`}));return o.push(C({Stage:i,NextStage:r,Option:"(Back to character actions.)",Result:"(Possible character actions.)"})),o}function h(e,t){return!(!t.Option||!t.Stage)&&(!e.some(e=>e.Stage===t.Stage&&e.Option===t.Option)&&(e.push(t),!0))}function C({Stage:e,NextStage:t=null,Option:a=null,Result:n=null,Function:i=null,Prerequisite:r=null,Group:o=null,Trait:l=null}){return{Stage:e??null,NextStage:t,Option:a,Result:n,Function:i,Prerequisite:r,Group:o,Trait:l}}function b(e){if("function"==typeof MiniGameStart)try{MiniGameStart(e.id,e.difficulty??0,"DialogBCMAMiniGameReturn")}catch(t){console.error("[BCMA] Failed to start mini-game",e.id,t)}}function y(e){return e?e.Nickname?e.Nickname:e.Name?e.Name:"number"==typeof e.MemberNumber?`Player ${e.MemberNumber}`:"Unknown player":"Unknown player"}function S(e,t){ServerPlayerIsInChatRoom()&&ServerSend("ChatRoomChat",{Content:"BCMA",Type:"Hidden",Target:e,Dictionary:t})}function M(){if(u)return;const e=globalThis.ChatRoomMessage;"function"==typeof e?(globalThis.ChatRoomMessage=function(a,...n){if("Hidden"!==a?.Type||"BCMA"!==a.Content||"object"!=typeof a.Dictionary)return e.call(this,a,...n);!function(e,a){if("string"==typeof a?.action)switch(a.action){case"invite":!function(e,a){if(a.target!==Player?.MemberNumber)return;const n=T(e),i=t.get(a.gameId);if(!i||!n)return void S(e,{action:"response",id:a.id,gameId:a.gameId,accepted:!1});const r=g[a.gameId];!function(t){A(),function(){if(d)return;const e=document.createElement("style");e.textContent="\n.bcma-opponent-overlay {\n\tposition: fixed;\n\tinset: 0;\n\tbackground: rgba(0, 0, 0, 0.6);\n\tdisplay: flex;\n\talign-items: center;\n\tjustify-content: center;\n\tz-index: 5000;\n}\n.bcma-opponent-dialog {\n\tbackground: #1b1b1f;\n\tcolor: white;\n\tborder: 1px solid #fff;\n\tpadding: 20px;\n\tmax-width: 420px;\n\twidth: 90%;\n\ttext-align: center;\n\tfont-family: Arial, sans-serif;\n\tbox-shadow: 0 0 15px rgba(0, 0, 0, 0.5);\n}\n.bcma-opponent-list {\n\tdisplay: flex;\n\tflex-direction: column;\n\tgap: 10px;\n\tmargin-top: 15px;\n}\n.bcma-opponent-list button {\n\tpadding: 10px;\n\tborder: 1px solid #5a5a74;\n\tbackground: #2d2d3a;\n\tcolor: white;\n\tcursor: pointer;\n}\n.bcma-opponent-list button:hover {\n\tbackground: #38384d;\n}\n",document.head.appendChild(e),d=!0}(),D=document.createElement("div"),D.className="bcma-opponent-overlay";const o=document.createElement("div");o.className="bcma-opponent-dialog";const l=document.createElement("p");l.textContent=t,o.appendChild(l);const c=document.createElement("div");c.className="bcma-opponent-list";const s=document.createElement("button");s.type="button",s.textContent="Accept",s.onclick=()=>{r&&r.prepareState(n),b(i),S(e,{action:"response",id:a.id,gameId:a.gameId,accepted:!0}),A()};const u=document.createElement("button");u.type="button",u.textContent="Decline",u.onclick=()=>{S(e,{action:"response",id:a.id,gameId:a.gameId,accepted:!1}),A()},c.appendChild(s),c.appendChild(u),o.appendChild(c),D.appendChild(o),document.body.appendChild(D)}(`${a.initiatorName} wants to play ${a.gameId}. Accept?`)}(e,a);break;case"response":!function(e){if(!l.has(e.id))return;l.delete(e.id);const a=o.get(e.id);if(o.delete(e.id),!a)return;if(!e.accepted)return void window.alert("BCMA: Invitation declined.");const n=t.get(a.gameId);if(!n)return;const i=g[a.gameId];i&&i.prepareState(a.opponent),b(n)}(a);break;case"forceStart":!function(e,a){const n=g[a.gameId],i=t.get(a.gameId);if(!n||!i)return;const r=T(e);r&&(n.prepareState(r),b(i))}(e,a)}}(a.Sender,a.Dictionary)},u=!0):setTimeout(M,500)}let D=null;function A(){D&&(D.remove(),D=null)}function T(e){return(Array.isArray(ChatRoomCharacter)?ChatRoomCharacter.find(t=>t.MemberNumber===e):null)??null}function B(){try{return"function"==typeof ServerPlayerIsInChatRoom&&ServerPlayerIsInChatRoom()}catch{return!1}}globalThis.BCMA_LOADED||(globalThis.BCMA_LOADED=!0,console.log(`[BCMA] Loading Bondage Club Multiplayer Activities v${globalThis.BCMA_VERSION??"dev"}`),function(){const e=globalThis;e.DialogBCMAStartMiniGame||(e.DialogBCMAStartMiniGame=e=>function(e){const a=t.get(e);return a?g[e]?(window.alert("BCMA: Please click on the opponent's character actions to start this activity."),!1):(b(a),!0):(console.warn(`[BCMA] Unknown mini-game requested: ${e}`),!1)}(e)),e.DialogBCMAStartMiniGameTarget||(e.DialogBCMAStartMiniGameTarget=e=>function(e){const a=t.get(e);if(!a)return console.warn(`[BCMA] Unknown mini-game requested: ${e}`),!1;const n=CurrentCharacter;if(!n||"function"!=typeof n.IsOnline||!n.IsOnline())return console.warn("[BCMA] No valid opponent selected"),!1;const i=g[e];if(i&&"number"==typeof n.MemberNumber){const t=n.MemberNumber;if(n.IsOwnedByPlayer?.())return i.prepareState(n),S(t,{action:"forceStart",gameId:e,initiator:Player?.MemberNumber??-1}),b(a),!0;const r=`${Player?.MemberNumber??"0"}-${Date.now()}-${Math.random().toString(36).slice(2)}`;return o.set(r,{gameId:e,opponent:n}),l.add(r),S(t,{action:"invite",id:r,gameId:e,initiator:Player?.MemberNumber??-1,target:t,initiatorName:y(Player)}),window.alert(`BCMA: Invitation sent to ${y(n)}.`),!0}return i?(console.warn("[BCMA] Cannot start this game without a valid opponent."),!1):(b(a),!0)}(e)),e.DialogBCMACanShowMiniGamesSelf||(e.DialogBCMACanShowMiniGamesSelf=()=>B()),e.DialogBCMACanShowMiniGamesTarget||(e.DialogBCMACanShowMiniGamesTarget=()=>{const t=e.CurrentCharacter;return!(!t||t===e.Player)&&("function"!=typeof t.IsPlayer||!t.IsPlayer())&&("function"!=typeof InventoryIsBlockedByDistance||!InventoryIsBlockedByDistance(t))&&B()}),e.DialogBCMACanShowMiniGames||(e.DialogBCMACanShowMiniGames=()=>{const t=e.CurrentCharacter;return t&&"function"==typeof t.IsPlayer&&t.IsPlayer()?e.DialogBCMACanShowMiniGamesSelf():e.DialogBCMACanShowMiniGamesTarget()}),e.DialogBCMAMiniGameReturn||(e.DialogBCMAMiniGameReturn=()=>{"string"==typeof CurrentModule&&"string"==typeof CurrentScreen&&"ChatRoom"===CurrentScreen||"function"==typeof CommonSetScreen&&CommonSetScreen("Online","ChatRoom")})}(),function(){const e=globalThis;if(c)return;const t=e.CharacterBuildDialog;"function"==typeof t?(c=t,e.CharacterBuildDialog=function(e,t,a,n){c?.call(this,e,t,a,n),p(e)}):console.warn("[BCMA] CharacterBuildDialog is not available; mini-game menu injection skipped.")}(),function(){const e=globalThis;if(s)return;const t=e.DialogCanPerformCharacterAction;"function"==typeof t&&(s=t,e.DialogCanPerformCharacterAction=function(){return!!s?.call(this)||"function"==typeof e.DialogBCMACanShowMiniGames&&e.DialogBCMACanShowMiniGames()})}(),m(),M())})();